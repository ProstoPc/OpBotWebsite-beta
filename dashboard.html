<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpBot - –†–µ–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ */
        :root {
            --primary-dark: #0a0a0a;
            --secondary-dark: #121212;
            --accent-blue: #00a8ff;
            --light-blue: #4cd3c2;
            --text-light: #f5f5f5;
            --text-gray: #b0b0b0;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ */
        /* ... */
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <span>OpBot Dashboard</span>
                </div>
                <div class="user-info" id="user-info" style="display: none;">
                    <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                    <span id="user-name"></span>
                    <button class="btn btn-secondary" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Auth Section -->
    <section class="auth-section" id="auth-section">
        <div class="container">
            <div class="auth-container">
                <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Discord</h2>
                <p>–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Discord</p>
                
                <a href="/auth/discord" class="btn btn-discord" id="discord-login">
                    <i class="fab fa-discord"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord
                </a>

                <div style="margin-top: 30px; padding: 20px; background: var(--primary-dark); border-radius: 8px;">
                    <h4><i class="fas fa-info-circle"></i> –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h4>
                    <p style="margin: 10px 0; color: var(--text-gray); font-size: 14px;">
                        ‚Ä¢ –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä<br>
                        ‚Ä¢ –í—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞<br>
                        ‚Ä¢ JavaScript –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section class="dashboard-section" id="dashboard-section">
        <div class="container">
            <h2>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-server"></i>
                    <div class="stat-number" id="servers-count">0</div>
                    <div>–°–µ—Ä–≤–µ—Ä–æ–≤</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-number" id="total-members">0</div>
                    <div>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-cogs"></i>
                    <div class="stat-number" id="active-features">0</div>
                    <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-bolt"></i>
                    <div class="stat-number" id="uptime">100%</div>
                    <div>–ê–ø—Ç–∞–π–º</div>
                </div>
            </div>

            <h3>–í–∞—à–∏ —Å–µ—Ä–≤–µ—Ä—ã</h3>
            <div class="servers-grid" id="servers-grid">
                <div class="loading" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤...
                </div>
            </div>
        </div>
    </section>

    <!-- Server Management Section (–æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ) -->
    <!-- ... -->

    <script>
        class RealDiscordDashboard {
            constructor() {
                this.sessionId = null;
                this.currentUser = null;
                this.userGuilds = [];
                this.currentGuild = null;
                this.apiBaseUrl = '';
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.checkAuth();
            }

            setupEventListeners() {
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());
                document.getElementById('back-btn').addEventListener('click', () => this.showDashboard());

                // –í–∫–ª–∞–¥–∫–∏
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        this.switchTab(tabName);
                    });
                });

                // Toggle switches
                document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        const statusText = e.target.parentElement.nextElementSibling;
                        statusText.textContent = e.target.checked ? '–í–∫–ª—é—á–µ–Ω–æ' : '–í—ã–∫–ª—é—á–µ–Ω–æ';
                        statusText.style.color = e.target.checked ? 'var(--success)' : 'var(--error)';
                    });
                });

                // JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
                document.getElementById('welcome-json').addEventListener('input', () => this.updatePreview('welcome'));
                document.getElementById('farewell-json').addEventListener('input', () => this.updatePreview('farewell'));
            }

            async checkAuth() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º sessionId –≤ URL
                const urlParams = new URLSearchParams(window.location.search);
                const sessionParam = urlParams.get('session');
                
                if (sessionParam) {
                    this.sessionId = sessionParam;
                    // –û—á–∏—â–∞–µ–º URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    await this.loadUserData();
                } else {
                    this.showAuth();
                }
            }

            async loadUserData() {
                try {
                    const userResponse = await this.apiCall('/api/user');
                    this.currentUser = userResponse.user;
                    
                    await this.loadGuilds();
                    this.showDashboard();
                    this.updateUserInfo();
                    
                } catch (error) {
                    console.error('Failed to load user data:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                    this.showAuth();
                }
            }

            async loadGuilds() {
                try {
                    const guildsResponse = await this.apiCall('/api/guilds');
                    this.userGuilds = guildsResponse.guilds;
                    this.renderGuilds();
                    this.updateStats();
                    
                } catch (error) {
                    console.error('Failed to load guilds:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤', 'error');
                }
            }

            renderGuilds() {
                const grid = document.getElementById('servers-grid');
                
                if (this.userGuilds.length === 0) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <i class="fas fa-server" style="font-size: 3rem; color: var(--text-gray); margin-bottom: 20px;"></i>
                            <h3>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
                            <p>–£ –≤–∞—Å –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –±–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = '';

                this.userGuilds.forEach(guild => {
                    const card = document.createElement('div');
                    card.className = 'server-card';
                    
                    const iconUrl = guild.icon 
                        ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`
                        : null;
                    
                    card.innerHTML = `
                        ${iconUrl ? 
                            `<img src="${iconUrl}" class="server-icon" alt="${guild.name}">` :
                            `<div style="font-size: 2rem; margin-bottom: 10px;">üè†</div>`
                        }
                        <h3>${guild.name}</h3>
                        <p>üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${guild.member_count?.toLocaleString() || 'N/A'}</p>
                        <div class="server-actions">
                            <button class="btn btn-primary" onclick="dashboard.manageServer('${guild.id}')">
                                <i class="fas fa-cog"></i> –£–ø—Ä–∞–≤–ª—è—Ç—å
                            </button>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            }

            async manageServer(guildId) {
                const guild = this.userGuilds.find(g => g.id === guildId);
                if (guild) {
                    this.currentGuild = guild;
                    document.getElementById('server-name').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${guild.name}`;
                    
                    this.showServerManagement();
                    await this.loadServerData(guildId);
                }
            }

            async loadServerData(guildId) {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã
                    const channelsResponse = await this.apiCall(`/api/guilds/${guildId}/channels`);
                    this.fillChannelSelect('welcome-channel', channelsResponse.channels);
                    this.fillChannelSelect('farewell-channel', channelsResponse.channels);
                    this.fillChannelSelect('modlog-channel', channelsResponse.channels);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏
                    const rolesResponse = await this.apiCall(`/api/guilds/${guildId}/roles`);
                    this.fillRoleSelect('autorole-role', rolesResponse.roles);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    await this.loadCurrentSettings(guildId);
                    
                } catch (error) {
                    console.error('Failed to load server data:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                }
            }

            fillChannelSelect(selectId, channels) {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</option>';
                
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = `#${channel.name}`;
                    select.appendChild(option);
                });
            }

            fillRoleSelect(selectId, roles) {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.name;
                    select.appendChild(option);
                });
            }

            async loadCurrentSettings(guildId) {
                try {
                    const settings = await this.apiCall(`/api/guilds/${guildId}/settings`);
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—ã —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    if (settings.welcome) {
                        document.getElementById('welcome-enabled').checked = settings.welcome.enabled || false;
                        document.getElementById('welcome-channel').value = settings.welcome.channel_id || '';
                        if (settings.welcome.message) {
                            document.getElementById('welcome-json').value = JSON.stringify(settings.welcome.message, null, 2);
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã toggle switches
                    document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                        toggle.dispatchEvent(new Event('change'));
                    });

                    this.updatePreview('welcome');
                    this.updatePreview('farewell');
                    
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }

            async saveSettings(type) {
                if (!this.currentGuild) return;

                try {
                    const settings = {};
                    const guildId = this.currentGuild.id;

                    switch (type) {
                        case 'welcome':
                            settings.welcome = {
                                enabled: document.getElementById('welcome-enabled').checked,
                                channel_id: document.getElementById('welcome-channel').value,
                                message: JSON.parse(document.getElementById('welcome-json').value)
                            };
                            break;
                        case 'farewell':
                            settings.farewell = {
                                enabled: document.getElementById('farewell-enabled').checked,
                                channel_id: document.getElementById('farewell-channel').value,
                                message: JSON.parse(document.getElementById('farewell-json').value)
                            };
                            break;
                        case 'autorole':
                            settings.autorole = {
                                enabled: document.getElementById('autorole-enabled').checked,
                                role_id: document.getElementById('autorole-role').value,
                                delay: parseInt(document.getElementById('autorole-delay').value) || 0
                            };
                            break;
                    }

                    await this.apiCall(`/api/guilds/${guildId}/settings`, 'POST', settings);
                    this.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                    this.updateStats();
                    
                } catch (error) {
                    console.error('Save failed:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                }
            }

            async apiCall(endpoint, method = 'GET', body = null) {
                const options = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${this.sessionId}`,
                        'Content-Type': 'application/json'
                    }
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(endpoint, options);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        this.logout();
                        throw new Error('Unauthorized');
                    }
                    throw new Error(`API error: ${response.status}`);
                }

                return await response.json();
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = `${this.currentUser.username}#${this.currentUser.discriminator}`;
                    document.getElementById('user-name').textContent = userName;
                    
                    const avatarUrl = this.currentUser.avatar 
                        ? `https://cdn.discordapp.com/avatars/${this.currentUser.id}/${this.currentUser.avatar}.png`
                        : `https://cdn.discordapp.com/embed/avatars/${this.currentUser.discriminator % 5}.png`;
                    
                    document.getElementById('user-avatar').src = avatarUrl;
                }
            }

            updateStats() {
                document.getElementById('servers-count').textContent = this.userGuilds.length;
                
                const totalMembers = this.userGuilds.reduce((sum, guild) => 
                    sum + (guild.member_count || 0), 0
                );
                document.getElementById('total-members').textContent = totalMembers.toLocaleString();
                
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
                document.getElementById('active-features').textContent = '0';
            }

            showAuth() {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('dashboard-section').style.display = 'none';
                document.getElementById('server-management').style.display = 'none';
                document.getElementById('user-info').style.display = 'none';
            }

            showDashboard() {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('server-management').style.display = 'none';
                document.getElementById('user-info').style.display = 'flex';
            }

            showServerManagement() {
                document.getElementById('dashboard-section').style.display = 'none';
                document.getElementById('server-management').style.display = 'block';
            }

            async logout() {
                try {
                    await this.apiCall('/api/logout', 'POST');
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ logout
                }
                
                this.sessionId = null;
                this.currentUser = null;
                this.userGuilds = [];
                this.showAuth();
                this.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }

            updatePreview(type) {
                const jsonTextarea = document.getElementById(`${type}-json`);
                const previewContent = document.getElementById(`${type}-preview-content`);
                
                try {
                    const jsonData = JSON.parse(jsonTextarea.value);
                    previewContent.innerHTML = `
                        <div style="color: var(--success); margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> JSON –≤–∞–ª–∏–¥–µ–Ω
                        </div>
                        <div style="background: var(--secondary-dark); padding: 15px; border-radius: 5px;">
                            <strong>–ö–æ–Ω—Ç–µ–Ω—Ç:</strong> ${jsonData.content || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                            <strong>–≠–º–±–µ–¥–æ–≤:</strong> ${jsonData.embeds ? jsonData.embeds.length : 0}
                        </div>
                    `;
                } catch (error) {
                    previewContent.innerHTML = `
                        <div style="color: var(--error);">
                            <i class="fas fa-exclamation-circle"></i> –û—à–∏–±–∫–∞ –≤ JSON: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        async function saveSettings(type) {
            await dashboard.saveSettings(type);
        }

        function testFeature(type) {
            dashboard.showNotification(`–§—É–Ω–∫—Ü–∏—è "${type}" –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞!`, 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new RealDiscordDashboard();
        });
    </script>
</body>
</html>
